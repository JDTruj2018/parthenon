<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>State Management &mdash; Parthenon  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Domain" href="../mesh/domain.html" />
    <link rel="prev" title="Sparse implementation" href="sparse.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Parthenon
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../amr.html">Adaptive Mesh Refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary_communication.html">Boundary communication-in-one concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary_communication.html#sparse-boundary-communication">Sparse boundary communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary_conditions.html">Boundary Conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">Building Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts_lite.html">C++11 Style Concepts Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../constants.html">Parthenon Built-in Physical Constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coordinates.html">Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Parthenon developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver.html">Application Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inputs.html">Input Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integrators.html">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nested_par_for.html">Nested Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outputs.html">Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parthenon_arrays.html">Parthenon Set-Dimensional Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parthenon_arrays.html#parthenon-arbitrary-dimensional-arrays">Parthenon Arbitrary-Dimensional Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../particles.html">Particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reductions.html">Task-based reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../solvers.html">Solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sphinx-doc.html">How to Use Sphinx for Writing Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../weak_scaling.html">Running a Weak Scaling Test in Parthenon</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundary.html">Boundary related classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="refinement_operations.html">Prolongation and Restriction Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse.html">Sparse implementation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">State Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#metadata">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="#statedescriptor">StateDescriptor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#history-output">History output</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pararraynd">ParArrayND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cellvariable">CellVariable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#facevariable-work-in-progress">FaceVariable (Work in progress…)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#edgevariable-work-in-progress">EdgeVariable (Work in progress…)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sparse-fields">Sparse fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="#meshblockdata">MeshBlockData</a></li>
<li class="toctree-l2"><a class="reference internal" href="#datacollection">DataCollection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mesh/domain.html">Domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mesh/mesh.html">Mesh</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Parthenon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">State Management</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/src/interface/state.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="state-management">
<span id="state"></span><h1>State Management<a class="headerlink" href="#state-management" title="Link to this heading"></a></h1>
<p>Parthenon manages simulation data through a hierarchy of classes
designed to provide convenient state management but also
high-performance in low-level, performance critical kernels. This page
gives an overview of the basic classes involved in state management.</p>
<section id="metadata">
<h2>Metadata<a class="headerlink" href="#metadata" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Metadata</span></code> class provides a means of defining self-describing
variables within Parthenon. It’s documentation can be found
<a class="reference internal" href="metadata.html#metadata"><span class="std std-ref">here</span></a>.</p>
</section>
<section id="statedescriptor">
<h2>StateDescriptor<a class="headerlink" href="#statedescriptor" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">StateDescriptor</span></code> class is intended to be used to inform Parthenon
about the needs of an application and store relevant parameters that
control application-specific behavior at runtime. The class provides
several useful features and functions.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">AddField(const</span> <span class="pre">std::string&amp;</span> <span class="pre">field_name,</span> <span class="pre">Metadata&amp;</span> <span class="pre">m)</span></code> provides
the means to add new (dense) variables to a Parthenon-based application
with associated <code class="docutils literal notranslate"><span class="pre">Metadata</span></code>. This function does not allocate any
storage or create any of the objects below, it simply adds the name and
<code class="docutils literal notranslate"><span class="pre">Metadata</span></code> to a list so that those objects can be populated at the
appropriate time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">AddSparsePool(...)</span></code> either adds a given
<code class="docutils literal notranslate"><span class="pre">SparsePool</span></code> or forwards the arguments to the <code class="docutils literal notranslate"><span class="pre">SparsePool</span></code>
constructor. A <code class="docutils literal notranslate"><span class="pre">SparsePool</span></code> is a collection of sparse variable fields
that share the same base name and <code class="docutils literal notranslate"><span class="pre">Metadata</span></code>, except that the shape,
<code class="docutils literal notranslate"><span class="pre">Vector</span></code>/<code class="docutils literal notranslate"><span class="pre">Tensor</span></code> metadata flags, and component names can be
specified per sparse id. Currently, sparse variables are allocated on
all blocks just like dense variables, however, in a future upgrade, they
will only be allocated on those blocks where the user explicitly
allocates them or non-zero values are advected into.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">AddParam&lt;T&gt;(const</span> <span class="pre">std::string&amp;</span> <span class="pre">key,</span> <span class="pre">T&amp;</span> <span class="pre">value,</span> <span class="pre">bool</span> <span class="pre">is_mutable)</span></code>
adds a parameter (e.g., a timestep control coefficient, refinement
tolerance, etc.) with name <code class="docutils literal notranslate"><span class="pre">key</span></code> and value <code class="docutils literal notranslate"><span class="pre">value</span></code>. If
<code class="docutils literal notranslate"><span class="pre">is_mutable</span></code> is true, parameters can be more easily modified.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">UpdateParam&lt;T&gt;(const</span> <span class="pre">std::string&amp;</span> <span class="pre">key,</span> <span class="pre">T&amp;</span> <span class="pre">value)</span></code>updates a
parameter (e.g., a timestep control coefficient, refinement tolerance,
etc.) with name <code class="docutils literal notranslate"><span class="pre">key</span></code> and value <code class="docutils literal notranslate"><span class="pre">value</span></code>. A parameter of the same
type must exist.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">T&amp;</span> <span class="pre">Param(const</span> <span class="pre">std::string&amp;</span> <span class="pre">key)</span></code> provides
the getter to access parameters previously added by <code class="docutils literal notranslate"><span class="pre">AddParam</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">*MutableParam(const</span> <span class="pre">std::string</span> <span class="pre">&amp;key)</span></code> returns a pointer to a
parameter that has been marked mutable when it was added. Note this
pointer is <em>not</em> marked <code class="docutils literal notranslate"><span class="pre">const</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">FillDerivedBlock(MeshBlockData&lt;Real&gt;*</span> <span class="pre">rc)</span></code> delgates to the
<code class="docutils literal notranslate"><span class="pre">std::function</span></code> member <code class="docutils literal notranslate"><span class="pre">FillDerivedBlock</span></code> if set (defaults to
<code class="docutils literal notranslate"><span class="pre">nullptr</span></code> and therefore a no-op) that allows an application to provide
a function that fills in derived quantities from independent state per
<code class="docutils literal notranslate"><span class="pre">MeshBlockData&lt;Real&gt;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">FillDerivedMesh(MeshData&lt;Real&gt;*</span> <span class="pre">rc)</span></code>
delegates to the <code class="docutils literal notranslate"><span class="pre">std::function</span></code> member <code class="docutils literal notranslate"><span class="pre">FillDerivedMesh</span></code> if set
(defaults to <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> and therefore a no-op) that allows an
application to provide a function that fills in derived quantities from
independent state per <code class="docutils literal notranslate"><span class="pre">MeshData&lt;Real&gt;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Real</span> <span class="pre">EstimateTimestepBlock(MeshBlockData&lt;Real&gt;*</span> <span class="pre">rc)</span></code> delgates to the
<code class="docutils literal notranslate"><span class="pre">std::function</span></code> member <code class="docutils literal notranslate"><span class="pre">EstimateTimestepBlock</span></code> if set (defaults to
<code class="docutils literal notranslate"><span class="pre">nullptr</span></code> and therefore a no-op) that allows an application to provide
a means of computing stable/accurate timesteps for a mesh block.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Real</span> <span class="pre">EstimateTimestepMesh(MeshData&lt;Real&gt;*</span> <span class="pre">rc)</span></code> delgates to the
<code class="docutils literal notranslate"><span class="pre">std::function</span></code> member <code class="docutils literal notranslate"><span class="pre">EstimateTimestepBlock</span></code> if set (defaults to
<code class="docutils literal notranslate"><span class="pre">nullptr</span></code> and therefore a no-op) that allows an application to provide
a means of computing stable/accurate timesteps for a mesh block.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AmrTag</span> <span class="pre">CheckRefinement(MeshBlockData&lt;Real&gt;*</span> <span class="pre">rc)</span></code> delegates to the
<code class="docutils literal notranslate"><span class="pre">std::function</span></code> member <code class="docutils literal notranslate"><span class="pre">CheckRefinementBlock</span></code> if set (defaults to
<code class="docutils literal notranslate"><span class="pre">nullptr</span></code> and therefore a no-op) that allows an application to define
an application-specific refinement/de-refinement tagging function.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">PreStepDiagnostics(SimTime</span> <span class="pre">const</span> <span class="pre">&amp;simtime,</span> <span class="pre">MeshData&lt;Real&gt;</span> <span class="pre">*rc)</span></code>
deletgates to the <code class="docutils literal notranslate"><span class="pre">std::function</span></code> member <code class="docutils literal notranslate"><span class="pre">PreStepDiagnosticsMesh</span></code> if
set (defaults to <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> an therefore a no-op) to print diagnostics
before the time-integration advance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">PostStepDiagnostics(SimTime</span> <span class="pre">const</span> <span class="pre">&amp;simtime,</span> <span class="pre">MeshData&lt;Real&gt;</span> <span class="pre">*rc)</span></code>
deletgates to the <code class="docutils literal notranslate"><span class="pre">std::function</span></code> member <code class="docutils literal notranslate"><span class="pre">PostStepDiagnosticsMesh</span></code>
if set (defaults to <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> an therefore a no-op) to print
diagnostics after the time-integration advance</p></li>
</ul>
<p>The reasoning for providing <code class="docutils literal notranslate"><span class="pre">FillDerived*</span></code> and <code class="docutils literal notranslate"><span class="pre">EstimateTimestep*</span></code>
function pointers appropriate for usage with both <code class="docutils literal notranslate"><span class="pre">MeshData</span></code> and
<code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> is to allow downstream applications better control
over task/kernel granularity. If, for example, the functionality needed
in a package’s <code class="docutils literal notranslate"><span class="pre">FillDerived*</span></code> function is minimal (e.g., computing
velocity from momentum and mass), better performance may be acheived by
making use of the <code class="docutils literal notranslate"><span class="pre">FillDerivedMesh</span></code> interface. Note that applications
and even individual packages can make simultaneous usage of <em>both</em>
<code class="docutils literal notranslate"><span class="pre">*Mesh</span></code> and <code class="docutils literal notranslate"><span class="pre">*Block</span></code> functions, so long as the appropriate tasks are
called as needed by the application driver.</p>
<p>In Parthenon, each <code class="docutils literal notranslate"><span class="pre">Mesh</span></code> and <code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code> owns a <code class="docutils literal notranslate"><span class="pre">Packages_t</span></code>
object, which is a
<code class="docutils literal notranslate"><span class="pre">std::map&lt;std::string,</span> <span class="pre">std::shared_ptr&lt;StateDescriptor&gt;&gt;</span></code>. The object
is intended to be populated with a <code class="docutils literal notranslate"><span class="pre">StateDescriptor</span></code> object per
package via an <code class="docutils literal notranslate"><span class="pre">Initialize</span></code> function as in the advection example
<a class="reference external" href="https://github.com/parthenon-hpc-lab/parthenon/blob/develop/docs/example/advection/advection.cpp">here</a>. When Parthenon makes use
of the <code class="docutils literal notranslate"><span class="pre">Packages_t</span></code> object, it iterates over all entries in the
<code class="docutils literal notranslate"><span class="pre">std::map</span></code>. Note that it’s often useful to add a <code class="docutils literal notranslate"><span class="pre">StateDescriptor</span></code>
to the <code class="docutils literal notranslate"><span class="pre">Packages_t</span></code> object for the overall application, allowing for a
convenient way to define global parameters, for example.</p>
</section>
<section id="history-output">
<span id="state-history-output"></span><h2>History output<a class="headerlink" href="#history-output" title="Link to this heading"></a></h2>
<p>Parthenon allows packages to enroll an arbitrary number of “history”
functions that are all called at the interval according to the input
parameters, see <a class="reference internal" href="../outputs.html#output-hist-files"><span class="std std-ref">output documention</span></a>.</p>
<p>To enroll functions create a list of callback function with the
appropriate reduction operation:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// List (vector) of HistoryOutputVar that will all be enrolled as output variables</span>
<span class="n">parthenon</span><span class="o">::</span><span class="n">HstVar_list</span><span class="w"> </span><span class="n">hst_vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="c1">// Add a callback function</span>
<span class="n">hst_vars</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">parthenon</span><span class="o">::</span><span class="n">HistoryOutputVar</span><span class="p">(</span><span class="n">UserHistoryOperation</span><span class="o">::</span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="n">MyHstFunction</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my label&quot;</span><span class="p">));</span>

<span class="c1">// add callbacks for HST output identified by the `hist_param_key`</span>
<span class="n">pkg</span><span class="o">-&gt;</span><span class="n">AddParam</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">parthenon</span><span class="o">::</span><span class="n">hist_param_key</span><span class="p">,</span><span class="w"> </span><span class="n">hst_vars</span><span class="p">);</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">HistoryOutputVar</span></code> is a <code class="docutils literal notranslate"><span class="pre">struct</span></code> containing the global (over
all blocks of all ranks) reduction operation, <code class="docutils literal notranslate"><span class="pre">MyHstFunction</span></code> is a
callback function (see below), and <code class="docutils literal notranslate"><span class="pre">&quot;my</span> <span class="pre">label&quot;</span></code> is the string to be
used as the column heading of the output file.</p>
<p>Currently supported reductions are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UserHistoryOperation::sum</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UserHistoryOperation::min</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UserHistoryOperation::max</span></code></p></li>
</ul>
<p>which all match their respective MPI counterpart. <em>Note</em>, in case of
volume weighting being desired (e.g., to calculate the total value in
the simulation domain of some density) the volume weighting need to be
done within the callback function, see the <a class="reference external" href="https://github.com/parthenon-hpc-lab/parthenon/blob/develop/example/advection/advection_package.cpp">advection
example</a>.</p>
<p>Callback functions need to have the following signature</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Real</span><span class="w"> </span><span class="nf">MyHstFunction</span><span class="p">(</span><span class="n">MeshData</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">md</span><span class="p">);</span>
</pre></div>
</div>
<p>i.e., they will always work on <code class="docutils literal notranslate"><span class="pre">MeshData</span></code>. <em>Note</em>, currently history
output will always be calculated for the “base” container. More
specifically, the output machinery will automatically use (or create if
non existent) a single “base” <code class="docutils literal notranslate"><span class="pre">MeshData</span></code> object containing <em>all</em>
blocks of a rank. This simplifies the the logic for reductions over all
blocks of a rank and also (generally) resuls in better performance as
the number of kernel calls is reduced. However, this also implies the
expectation that the “base” container holds the most recent data at the
end of a timestep.</p>
</section>
<section id="pararraynd">
<h2>ParArrayND<a class="headerlink" href="#pararraynd" title="Link to this heading"></a></h2>
<p>This provides a light wrapper around <code class="docutils literal notranslate"><span class="pre">Kokkos::View</span></code> with some
convenience features. It is described fully
<a class="reference internal" href="../parthenon_arrays.html#pararrays"><span class="std std-ref">here</span></a>.</p>
</section>
<section id="cellvariable">
<span id="cell-var"></span><h2>CellVariable<a class="headerlink" href="#cellvariable" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">CellVariable</span></code> class collects several associated objects that are
needed to store, describe, and update simulation data. <code class="docutils literal notranslate"><span class="pre">CellVariable</span></code>
is templated on type <code class="docutils literal notranslate"><span class="pre">T</span></code> and includes the following member data (names
preceded by <code class="docutils literal notranslate"><span class="pre">_</span></code> have private scope):</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Member Data</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ParArrayND&lt;T&gt;</span> <span class="pre">data</span></code></p></td>
<td><p>Storage for the cell-centered associated with the object.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ParArrayND&lt;T&gt;</span> <span class="pre">flux[3]</span></code></p></td>
<td><p>Storage for the face-centered intercell fluxes in each direction. Only allocated for fields registered with the <code class="docutils literal notranslate"><span class="pre">Metadata::Independent</span></code> flag.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ParArrayND&lt;T&gt;</span> <span class="pre">coarse_s</span></code></p></td>
<td><p>Storage for coarse buffers need for multilevel setups.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Metadata</span> <span class="pre">m_</span></code></p></td>
<td><p>See <a class="reference internal" href="metadata.html#metadata"><span class="std std-ref">here</span></a>.</p></td>
</tr>
</tbody>
</table>
<p>Additionally, the class overloads the <code class="docutils literal notranslate"><span class="pre">()</span></code> operator to provide
convenient access to the <code class="docutils literal notranslate"><span class="pre">data</span></code> array, though this may be less
efficient than operating directly on <code class="docutils literal notranslate"><span class="pre">data</span></code> or a reference/copy of
that array.</p>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">IsSet(const</span> <span class="pre">MetadataFlag</span> <span class="pre">bit)</span></code> member function
provides a convenient mechanism to query whether a particular
<code class="docutils literal notranslate"><span class="pre">Metadata</span></code> flag is set for the <code class="docutils literal notranslate"><span class="pre">CellVariable</span></code>.</p>
</section>
<section id="facevariable-work-in-progress">
<h2>FaceVariable (Work in progress…)<a class="headerlink" href="#facevariable-work-in-progress" title="Link to this heading"></a></h2>
</section>
<section id="edgevariable-work-in-progress">
<h2>EdgeVariable (Work in progress…)<a class="headerlink" href="#edgevariable-work-in-progress" title="Link to this heading"></a></h2>
</section>
<section id="sparse-fields">
<h2>Sparse fields<a class="headerlink" href="#sparse-fields" title="Link to this heading"></a></h2>
<p>Sparse fields can be added via the <code class="docutils literal notranslate"><span class="pre">StateDescriptor::AddSparsePool</span></code>
function. A <code class="docutils literal notranslate"><span class="pre">SparsePool</span></code> is a collection of sparse fields that share a
common base name and metadata (see details below), but each sparse ID
produces a distinct <code class="docutils literal notranslate"><span class="pre">CellVariable</span></code>. For example, a <code class="docutils literal notranslate"><span class="pre">SparsePool</span></code> with
base name <code class="docutils literal notranslate"><span class="pre">sparse</span></code> and sparse IDs <code class="docutils literal notranslate"><span class="pre">{3,</span> <span class="pre">10,</span> <span class="pre">11,</span> <span class="pre">2097}</span></code> will produce
four <code class="docutils literal notranslate"><span class="pre">CellVariable</span></code>s: <code class="docutils literal notranslate"><span class="pre">sparse_3</span></code>, <code class="docutils literal notranslate"><span class="pre">sparse_10</span></code>, <code class="docutils literal notranslate"><span class="pre">sparse_11</span></code>,
and <code class="docutils literal notranslate"><span class="pre">sparse_2097</span></code>. These variables can be accessed either via their
full name or the combination of base name and sparse ID. Furthermore, in
a future upgrade, the sparse fields will not be allocated on all blocks
but can be allocated only on specific blocks with a custom prescription
on how to handle when they advect to neighboring blocks.</p>
<p>All the sparse field of a <code class="docutils literal notranslate"><span class="pre">SparsePool</span></code> share the same metadata, except
for the following, which can be specified individually for each sparse
ID (but they don’t have to be specified, if they are not given, they are
copied from the shared metadata of the pool): - Shape -
<code class="docutils literal notranslate"><span class="pre">Vector</span></code>/<code class="docutils literal notranslate"><span class="pre">Tensor</span></code> metadata flag (since that may be tied to shape) -
Component labels (which is usually also tied to shape)</p>
<p>In particular, the associated string is shared between all sparse IDs of
the same pool, so if the metadata used to create the pool has associated
“foo”, then all the sparse IDs of that pool will have associated “foo”.</p>
</section>
<section id="meshblockdata">
<h2>MeshBlockData<a class="headerlink" href="#meshblockdata" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> class provides a means of organizing and accessing
simulation data. New <code class="docutils literal notranslate"><span class="pre">Variable</span></code>s are added to a <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code>
container via the <code class="docutils literal notranslate"><span class="pre">Add</span></code> member function and accessed via various
<code class="docutils literal notranslate"><span class="pre">Get*</span></code> functions. These <code class="docutils literal notranslate"><span class="pre">Get*</span></code> functions provide access to the
various kinds of <code class="docutils literal notranslate"><span class="pre">Variable</span></code> objects described above, typically by
name.</p>
</section>
<section id="datacollection">
<h2>DataCollection<a class="headerlink" href="#datacollection" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">DataCollection</span></code> class is the highest level abstraction in
Parthenon’s state management. Each <code class="docutils literal notranslate"><span class="pre">MeshBlock</span></code> in a simulation owns a
<code class="docutils literal notranslate"><span class="pre">DataCollection</span></code> that through the classes just described, manages all
of the simulation data. Every <code class="docutils literal notranslate"><span class="pre">DataCollection</span></code> is initialized with a
<code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container named <code class="docutils literal notranslate"><span class="pre">&quot;base&quot;</span></code>. The <code class="docutils literal notranslate"><span class="pre">Get</span></code> function, when
invoked without arguments, returns a reference to this base
<code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container which is intended to contain all of the
simulation data that persists between timesteps (if applicable).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Add(const</span> <span class="pre">std::string&amp;</span> <span class="pre">label,</span> <span class="pre">MeshBlockData&lt;T&gt;&amp;</span> <span class="pre">src)</span></code> member
function creates a new <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container with the provided
label. This new <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container is populated with all of the
variables in <code class="docutils literal notranslate"><span class="pre">src</span></code>. When a variable has the <code class="docutils literal notranslate"><span class="pre">Metadata::OneCopy</span></code> flag
set, the variables in the new <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container are just
shallow copies from <code class="docutils literal notranslate"><span class="pre">src</span></code>, i.e. no new storage for data is allocated,
the <code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code> to the variable is just copied. For variables
that do not have <code class="docutils literal notranslate"><span class="pre">Metadata::OneCopy</span></code> set, new storage is allocated.
Once created, these new containers are accesible by calling <code class="docutils literal notranslate"><span class="pre">Get</span></code> with
the name of the desired <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container as an argument.
NOTE: The <code class="docutils literal notranslate"><span class="pre">Add</span></code> function checks if a <code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container by
the name <code class="docutils literal notranslate"><span class="pre">label</span></code> already exists in the collection, immediately
returning if one is found (or throwing a <code class="docutils literal notranslate"><span class="pre">std::runtime_error</span></code> if the
new and pre-existing containers are not equivalent). Therefore, adding a
<code class="docutils literal notranslate"><span class="pre">MeshBlockData</span></code> container to the collection multiple times results in
a single new container, with the remainder of the calls no-ops.</p>
<p>The overload
<code class="docutils literal notranslate"><span class="pre">Add(const</span> <span class="pre">std::string</span> <span class="pre">&amp;label,</span> <span class="pre">MeshBlockData&lt;T&gt;</span> <span class="pre">&amp;src,</span> <span class="pre">const</span> <span class="pre">std::vector&lt;std::string&gt;</span> <span class="pre">&amp;names)</span></code>
provides the same functionality as the above <code class="docutils literal notranslate"><span class="pre">Add</span></code> function, but for a
subset of variables provided in the vector of names. This feature allows
downstream applications to allocate storage in a more targeted fashion,
as might be desirable to hold source terms for particular equations, for
example.</p>
<p>Two simple examples of usage of these new containers are 1) to provide
storage for multistage integration schemes and 2) to provide a mechanism
to allocate storage for right hand sides, deltas, etc. Both of these
usages are demonstrated in the advection example that ships with
Parthenon.</p>
<p>Note that in multistage integrator the fluxes and <code class="docutils literal notranslate"><span class="pre">bvars</span></code> (and their
MPI communicator) of a variable are shared by default across all stages.
This means that any kind of communication (most prominently flux
correction and ghost zone exchange) of a given variable at a given stage
should not be interleaved with any other modifications/communication of
said variable as it may result in undefined behavior.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="sparse.html" class="btn btn-neutral float-left" title="Sparse implementation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../mesh/domain.html" class="btn btn-neutral float-right" title="Domain" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Parthenon Collaboration and Triad National Security.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: jmm/fix-restart
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../../../regression-gold-v15/index.html">regression-gold-v15</a></dd>
      <dd><a href="../../../../regression-gold-v16/src/interface/state.html">regression-gold-v16</a></dd>
      <dd><a href="../../../../regression-gold-v17/src/interface/state.html">regression-gold-v17</a></dd>
      <dd><a href="../../../../regression-gold-v18/src/interface/state.html">regression-gold-v18</a></dd>
      <dd><a href="../../../../regression-gold-v19/src/interface/state.html">regression-gold-v19</a></dd>
      <dd><a href="../../../../v0.8.0/src/interface/state.html">v0.8.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../../bdw/gauss-quad/src/interface/state.html">bdw/gauss-quad</a></dd>
      <dd><a href="../../../../bprather/backport-bicgstab/src/interface/state.html">bprather/backport-bicgstab</a></dd>
      <dd><a href="../../../../bprather/backport-solvers/src/interface/state.html">bprather/backport-solvers</a></dd>
      <dd><a href="../../../../bprather/fix-amr-ct/src/interface/state.html">bprather/fix-amr-ct</a></dd>
      <dd><a href="../../../../bprather/fix-line-continuation/src/interface/state.html">bprather/fix-line-continuation</a></dd>
      <dd><a href="../../../../bprather/fix-mpi-comms/src/interface/state.html">bprather/fix-mpi-comms</a></dd>
      <dd><a href="../../../../bprather/mbd_add_niceties/src/interface/state.html">bprather/mbd_add_niceties</a></dd>
      <dd><a href="../../../../bprather/pep1/src/interface/state.html">bprather/pep1</a></dd>
      <dd><a href="../../../../bprather/print-less/src/interface/state.html">bprather/print-less</a></dd>
      <dd><a href="../../../../bprather/register-internal-op/src/interface/state.html">bprather/register-internal-op</a></dd>
      <dd><a href="../../../../bprather/reqs-for-ct/src/interface/state.html">bprather/reqs-for-ct</a></dd>
      <dd><a href="../../../../brryan/particle_idx_bug/src/interface/state.html">brryan/particle_idx_bug</a></dd>
      <dd><a href="../../../../develop/src/interface/state.html">develop</a></dd>
      <dd><a href="../../../../forrestglines/cuda-with-nvc++-fix/src/interface/state.html">forrestglines/cuda-with-nvc++-fix</a></dd>
      <dd><a href="../../../../forrestglines/curvilinear/src/interface/state.html">forrestglines/curvilinear</a></dd>
      <dd><a href="../../../../forrestglines/fix-deprecated-kokkos-num-devices/src/interface/state.html">forrestglines/fix-deprecated-kokkos-num-devices</a></dd>
      <dd><a href="../../../../jdolence/inactive_blocks/src/interface/state.html">jdolence/inactive_blocks</a></dd>
      <dd><a href="../../../../jdolence/meshblockdata_add/src/interface/state.html">jdolence/meshblockdata_add</a></dd>
      <dd><a href="../../../../jdolence/quickfixes/src/interface/state.html">jdolence/quickfixes</a></dd>
      <dd><a href="../../../../jdolence/timer_based_loadbalancing/src/interface/state.html">jdolence/timer_based_loadbalancing</a></dd>
      <dd><a href="../../../deprecate-unified-init/src/interface/state.html">jmm/deprecate-unified-init</a></dd>
      <dd><a href="../../../fix-noparticle-case/src/interface/state.html">jmm/fix-noparticle-case</a></dd>
      <dd><a href="state.html">jmm/fix-restart</a></dd>
      <dd><a href="../../../fix-throw-fail/index.html">jmm/fix-throw-fail</a></dd>
      <dd><a href="../../../flat-sparse/src/interface/state.html">jmm/flat-sparse</a></dd>
      <dd><a href="../../../flatpack-test/src/interface/state.html">jmm/flatpack-test</a></dd>
      <dd><a href="../../../get-me-off-this-rollercoaster/src/interface/state.html">jmm/get-me-off-this-rollercoaster</a></dd>
      <dd><a href="../../../hotfix-sparse-control-fields/src/interface/state.html">jmm/hotfix-sparse-control-fields</a></dd>
      <dd><a href="../../../metadata-fix/src/interface/state.html">jmm/metadata-fix</a></dd>
      <dd><a href="../../../metadataset/src/interface/state.html">jmm/metadataset</a></dd>
      <dd><a href="../../../particle-output/src/interface/state.html">jmm/particle-output</a></dd>
      <dd><a href="../../../precomms-fill-derived/src/interface/state.html">jmm/precomms-fill-derived</a></dd>
      <dd><a href="../../../../lfroberts36/speedup-buffer-kernel/src/interface/state.html">lfroberts36/speedup-buffer-kernel</a></dd>
      <dd><a href="../../../../lroberts36/add-index-range-masking/src/interface/state.html">lroberts36/add-index-range-masking</a></dd>
      <dd><a href="../../../../lroberts36/add-morton-numbers/src/interface/state.html">lroberts36/add-morton-numbers</a></dd>
      <dd><a href="../../../../lroberts36/add-multi-grid/src/interface/state.html">lroberts36/add-multi-grid</a></dd>
      <dd><a href="../../../../lroberts36/add-negative-levels/src/interface/state.html">lroberts36/add-negative-levels</a></dd>
      <dd><a href="../../../../lroberts36/add-noncell-amr/src/interface/state.html">lroberts36/add-noncell-amr</a></dd>
      <dd><a href="../../../../lroberts36/boundary-exchange-test/src/interface/state.html">lroberts36/boundary-exchange-test</a></dd>
      <dd><a href="../../../../lroberts36/composable-boundary-conditions/src/interface/state.html">lroberts36/composable-boundary-conditions</a></dd>
      <dd><a href="../../../../lroberts36/face-boundary-communication/src/interface/state.html">lroberts36/face-boundary-communication</a></dd>
      <dd><a href="../../../../lroberts36/fix-dealloc-count-bug/src/interface/state.html">lroberts36/fix-dealloc-count-bug</a></dd>
      <dd><a href="../../../../lroberts36/in-one-zero-memory-amr/src/interface/state.html">lroberts36/in-one-zero-memory-amr</a></dd>
      <dd><a href="../../../../lroberts36/local-face-fields/src/interface/state.html">lroberts36/local-face-fields</a></dd>
      <dd><a href="../../../../lroberts36/refactor-region-size/src/interface/state.html">lroberts36/refactor-region-size</a></dd>
      <dd><a href="../../../../lroberts36/rename-cell-variable/src/interface/state.html">lroberts36/rename-cell-variable</a></dd>
      <dd><a href="../../../../lroberts36/sparse-pack-update/src/interface/state.html">lroberts36/sparse-pack-update</a></dd>
      <dd><a href="../../../../pgrete/always-chunck/src/interface/state.html">pgrete/always-chunck</a></dd>
      <dd><a href="../../../../pgrete/fix-ascent-vars/src/interface/state.html">pgrete/fix-ascent-vars</a></dd>
      <dd><a href="../../../../pgrete/fix-chunk/src/interface/state.html">pgrete/fix-chunk</a></dd>
      <dd><a href="../../../../pgrete/sycl-test/src/interface/state.html">pgrete/sycl-test</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>